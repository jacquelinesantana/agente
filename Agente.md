Acesso a máquina privada por meio de Agent Forwarding
-----------------------------------------------------

[](https://github.com/jacquelinesantana/AWS/blob/main/bastion-host-guide.md#acesso-a-m%C3%A1quina-privada-por-meio-de-agent-forwarding)

É uma técnica que permite que você use a chave privada armazenada no seu computador local para autenticar em uma instância privada (na subnet privada), passando pelo bastion host, sem a necessidade de transferir ou copiar a chave privada para o bastion host. No final do material vamos ter algumas dicas para o uso dessa tecnica.

1. Abra o PowerShell como administrador
2. Execute o comando: `ssh-add .\chave.pem` (você deve estar dentro do diretório da sua chave ou indicar o caminho correto para a chave*)
3. Para verificar se a chave foi adicionada execute o comando: `ssh-add -l` (a letra após o - é L em caixa baixa)
4. Agora, acesse a máquina pública com o seguinte comando `ssh -A -i "NOMECHAVE.pem" ec2-user@IPDAMAQUINAPUBLICA` esse -A no comando vai permitir acessar a máquina "levando" a chave que copiamos no Agent Forwarding
5. dentro da máquina pública vamos executar o seguinte comando para acessar a máquina privada: `ssh ec2-user@IPMAQUINAPRIVADA` note que foi removido o -i e a chave [![resultado esperado: note que acessamos a máquina pública e ele mostra o ip dessa maquina e rodamos o ssh para acessar a máquina privada](https://private-user-images.githubusercontent.com/8031302/400166487-e2264a10-87ca-4be0-9db8-d6a5332f5fed.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzYyNDc3NjksIm5iZiI6MTczNjI0NzQ2OSwicGF0aCI6Ii84MDMxMzAyLzQwMDE2NjQ4Ny1lMjI2NGExMC04N2NhLTRiZTAtOWRiOC1kNmE1MzMyZjVmZWQucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MDEwNyUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTAxMDdUMTA1NzQ5WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9NjhkMDlhYzFiZmViYzJmYTdiMzRiMDhkN2QxZGRkYjcxNWU5NzU1YmFiMGViYTY5ZDNjYjUwNTZjMzVjMmRjMiZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.uBEGfnoKbkeMwwCDx8SqbbJJWB1dNzSyHGe0KaSF79c)](https://private-user-images.githubusercontent.com/8031302/400166487-e2264a10-87ca-4be0-9db8-d6a5332f5fed.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzYyNDc3NjksIm5iZiI6MTczNjI0NzQ2OSwicGF0aCI6Ii84MDMxMzAyLzQwMDE2NjQ4Ny1lMjI2NGExMC04N2NhLTRiZTAtOWRiOC1kNmE1MzMyZjVmZWQucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MDEwNyUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTAxMDdUMTA1NzQ5WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9NjhkMDlhYzFiZmViYzJmYTdiMzRiMDhkN2QxZGRkYjcxNWU5NzU1YmFiMGViYTY5ZDNjYjUwNTZjMzVjMmRjMiZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.uBEGfnoKbkeMwwCDx8SqbbJJWB1dNzSyHGe0KaSF79c) Nesse momento todo comando executado será executado dentro da máquina privada.

Acesso a internet dentro da máquina privada através da maquina bastion host
---------------------------------------------------------------------------

[](https://github.com/jacquelinesantana/AWS/blob/main/bastion-host-guide.md#acesso-a-internet-dentro-da-m%C3%A1quina-privada-atrav%C3%A9s-da-maquina-bastion-host)

Nesse momento você pode testar dar um simples comando de ping para validar que esta sem acesso a internet Para isso vamos impleentar o NAT Gateway. O NAT Gateway é necessário para que instâncias privadas possam acessar recursos na internet. Quando você utiliza um bastion host, ele atua como um intermediário para acessar as instâncias privadas, sem a necessidade de acesso direto à internet.

1. Crie um Nat Gateway passando um ip público para ele, aponte na Nat gateway a subnet publica para que essa consiga ver a intenet [![resultado esperado: ter a nat gateway criada com as informações da subnet publica associada a ela para que consiga sair para internet](https://private-user-images.githubusercontent.com/8031302/400171011-33d3b0fa-b05d-40e0-8292-276977cadd95.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzYyNDc3NjksIm5iZiI6MTczNjI0NzQ2OSwicGF0aCI6Ii84MDMxMzAyLzQwMDE3MTAxMS0zM2QzYjBmYS1iMDVkLTQwZTAtODI5Mi0yNzY5NzdjYWRkOTUucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MDEwNyUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTAxMDdUMTA1NzQ5WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9ZGI0NjY2ZWNkZjAzMmQwZGRjNjQ5MTA4NGRhZGM1Nzg4MjU5YTY4ZTc1NDcwZWNmMWI5ZTRlMzE3YTdhOTY3NiZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.0Aoxq9TYSToD4tt8CMJQfn2pp3z4SLtC8OBAhJb71l8)](https://private-user-images.githubusercontent.com/8031302/400171011-33d3b0fa-b05d-40e0-8292-276977cadd95.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzYyNDc3NjksIm5iZiI6MTczNjI0NzQ2OSwicGF0aCI6Ii84MDMxMzAyLzQwMDE3MTAxMS0zM2QzYjBmYS1iMDVkLTQwZTAtODI5Mi0yNzY5NzdjYWRkOTUucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MDEwNyUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTAxMDdUMTA1NzQ5WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9ZGI0NjY2ZWNkZjAzMmQwZGRjNjQ5MTA4NGRhZGM1Nzg4MjU5YTY4ZTc1NDcwZWNmMWI5ZTRlMzE3YTdhOTY3NiZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.0Aoxq9TYSToD4tt8CMJQfn2pp3z4SLtC8OBAhJb71l8)
2. Associe a tabela de roteamento da subnet privada com o nat que você criou [![resultado esperado: tabela de roteamento com as rotas associadas](https://private-user-images.githubusercontent.com/8031302/400171070-fb0552c5-96c9-4fc5-a64a-afd19516291b.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzYyNDc3NjksIm5iZiI6MTczNjI0NzQ2OSwicGF0aCI6Ii84MDMxMzAyLzQwMDE3MTA3MC1mYjA1NTJjNS05NmM5LTRmYzUtYTY0YS1hZmQxOTUxNjI5MWIucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MDEwNyUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTAxMDdUMTA1NzQ5WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9NDIyMTk0YTQ0ZWQzZGIyNTQyOTZjOTMzMzNkMzA4NWMwNGVlZjhmZmFiMmQ3NmEwYTUzZTYzMTBhZmQwMzFhYyZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.C114dI0ue11Vf6rnfNl5TWAwoH6QUcAtL_uoMLS5A2U)](https://private-user-images.githubusercontent.com/8031302/400171070-fb0552c5-96c9-4fc5-a64a-afd19516291b.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzYyNDc3NjksIm5iZiI6MTczNjI0NzQ2OSwicGF0aCI6Ii84MDMxMzAyLzQwMDE3MTA3MC1mYjA1NTJjNS05NmM5LTRmYzUtYTY0YS1hZmQxOTUxNjI5MWIucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MDEwNyUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTAxMDdUMTA1NzQ5WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9NDIyMTk0YTQ0ZWQzZGIyNTQyOTZjOTMzMzNkMzA4NWMwNGVlZjhmZmFiMmQ3NmEwYTUzZTYzMTBhZmQwMzFhYyZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.C114dI0ue11Vf6rnfNl5TWAwoH6QUcAtL_uoMLS5A2U)
3. Confirmar se a tabela de roteamento esta associada a sua subnet privada, caso não ajustar. OBS: faça o teste com ping para um site público a partir da maquina privada acessada através do bastion host, tenta tbm algum comando como:  `sudo yum update` e se tudo ocorreu conforme o esperado você vai obter sucesso para essas duas ações. [![resultado esperado: sucesso no ping e também na atualização](https://private-user-images.githubusercontent.com/8031302/400171195-59cc4288-3303-4e86-9dc4-5b5a66788e45.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzYyNDc3NjksIm5iZiI6MTczNjI0NzQ2OSwicGF0aCI6Ii84MDMxMzAyLzQwMDE3MTE5NS01OWNjNDI4OC0zMzAzLTRlODYtOWRjNC01YjVhNjY3ODhlNDUucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MDEwNyUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTAxMDdUMTA1NzQ5WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9MmQ2ODIwYjNkNTMzN2Y0OGU0ODJjNGUyMTBjYWY2M2I4NjE0NzE0YmZlY2MxNmRlMzVhMTU4ODI5ODJkZDE1MSZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.Izhk7pdwhCJTMYFzvPE2T9AsQfZ9NVSQoykswmbjTfo)](https://private-user-images.githubusercontent.com/8031302/400171195-59cc4288-3303-4e86-9dc4-5b5a66788e45.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzYyNDc3NjksIm5iZiI6MTczNjI0NzQ2OSwicGF0aCI6Ii84MDMxMzAyLzQwMDE3MTE5NS01OWNjNDI4OC0zMzAzLTRlODYtOWRjNC01YjVhNjY3ODhlNDUucG5nP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNyZWRlbnRpYWw9QUtJQVZDT0RZTFNBNTNQUUs0WkElMkYyMDI1MDEwNyUyRnVzLWVhc3QtMSUyRnMzJTJGYXdzNF9yZXF1ZXN0JlgtQW16LURhdGU9MjAyNTAxMDdUMTA1NzQ5WiZYLUFtei1FeHBpcmVzPTMwMCZYLUFtei1TaWduYXR1cmU9MmQ2ODIwYjNkNTMzN2Y0OGU0ODJjNGUyMTBjYWY2M2I4NjE0NzE0YmZlY2MxNmRlMzVhMTU4ODI5ODJkZDE1MSZYLUFtei1TaWduZWRIZWFkZXJzPWhvc3QifQ.Izhk7pdwhCJTMYFzvPE2T9AsQfZ9NVSQoykswmbjTfo)

Agent Forwarding dicas
======================

[](https://github.com/jacquelinesantana/AWS/blob/main/bastion-host-guide.md#agent-forwarding-dicas)

1. para saber se o OpenSSh esta instalado na sua máquina execute o comando:
    Get-WindowsCapability -Online | Where-Object Name -like 'OpenSSH*'

2. instalar o OpenSSh caso não esteja instalado:
    dism /Online /Add-Capability /CapabilityName:OpenSSH.Client~~~~0.0.1.0

3. verificar se o OpenSSH esta executando na sua máquina:
    Get-Service ssh-agent

4. iniciar o serviço OpenSSH:
    Start-Service ssh-agent


